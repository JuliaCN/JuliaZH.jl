<!DOCTYPE html>
<html lang="zh-cn"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>å¤šçº¿ç¨‹ Â· Juliaä¸­æ–‡æ–‡æ¡£</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-28835595-9', 'auto');
ga('send', 'pageview', {'page': location.pathname + location.search + location.hash});
</script><link rel="canonical" href="https://juliacn.github.io/JuliaZH.jl/latest/manual/multi-threading/"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/julia-manual.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Juliaä¸­æ–‡æ–‡æ¡£ logo"/></a><div class="docs-package-name"><span class="docs-autofit">Juliaä¸­æ–‡æ–‡æ¡£</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">ä¸»é¡µ</a></li><li><span class="tocitem">æ‰‹å†Œ</span><ul><li><a class="tocitem" href="../getting-started/">å…¥é—¨</a></li><li><a class="tocitem" href="../variables/">å˜é‡</a></li><li><a class="tocitem" href="../integers-and-floating-point-numbers/">æ•´æ•°å’Œæµ®ç‚¹æ•°</a></li><li><a class="tocitem" href="../mathematical-operations/">æ•°å­¦è¿ç®—å’Œåˆç­‰å‡½æ•°</a></li><li><a class="tocitem" href="../complex-and-rational-numbers/">å¤æ•°å’Œæœ‰ç†æ•°</a></li><li><a class="tocitem" href="../strings/">å­—ç¬¦ä¸²</a></li><li><a class="tocitem" href="../functions/">å‡½æ•°</a></li><li><a class="tocitem" href="../control-flow/">æµç¨‹æ§åˆ¶</a></li><li><a class="tocitem" href="../variables-and-scoping/">å˜é‡ä½œç”¨åŸŸ</a></li><li><a class="tocitem" href="../types/">ç±»å‹</a></li><li><a class="tocitem" href="../methods/">æ–¹æ³•</a></li><li><a class="tocitem" href="../constructors/">æ„é€ å‡½æ•°</a></li><li><a class="tocitem" href="../conversion-and-promotion/">ç±»å‹è½¬æ¢å’Œç±»å‹æå‡</a></li><li><a class="tocitem" href="../interfaces/">æ¥å£</a></li><li><a class="tocitem" href="../modules/">æ¨¡å—</a></li><li><a class="tocitem" href="../documentation/">æ–‡æ¡£</a></li><li><a class="tocitem" href="../metaprogramming/">å…ƒç¼–ç¨‹</a></li><li><a class="tocitem" href="../arrays/">å¤šç»´æ•°ç»„</a></li><li><a class="tocitem" href="../missing/">ç¼ºå¤±å€¼</a></li><li><a class="tocitem" href="../networking-and-streams/">ç½‘ç»œå’Œæµ</a></li><li><a class="tocitem" href="../parallel-computing/">å¹¶è¡Œè®¡ç®—</a></li><li><a class="tocitem" href="../asynchronous-programming/">Asynchronous Programming</a></li><li class="is-active"><a class="tocitem" href>å¤šçº¿ç¨‹</a><ul class="internal"><li><a class="tocitem" href="#å¯ç”¨Juliaå¤šçº¿ç¨‹"><span>å¯ç”¨Juliaå¤šçº¿ç¨‹</span></a></li><li><a class="tocitem" href="#Data-race-freedom"><span>Data-race freedom</span></a></li><li><a class="tocitem" href="#@threadså®"><span><code>@threads</code>å®</span></a></li><li><a class="tocitem" href="#åŸå­æ“ä½œ"><span>åŸå­æ“ä½œ</span></a></li><li><a class="tocitem" href="#man-atomics"><span>Per-field atomics</span></a></li><li><a class="tocitem" href="#å‰¯ä½œç”¨å’Œå¯å˜çš„å‡½æ•°å‚æ•°"><span>å‰¯ä½œç”¨å’Œå¯å˜çš„å‡½æ•°å‚æ•°</span></a></li><li><a class="tocitem" href="#@threadcall"><span>@threadcall</span></a></li><li><a class="tocitem" href="#Caveats"><span>Caveats</span></a></li><li><a class="tocitem" href="#Safe-use-of-Finalizers"><span>Safe use of Finalizers</span></a></li></ul></li><li><a class="tocitem" href="../distributed-computing/">Multi-processing and Distributed Computing</a></li><li><a class="tocitem" href="../running-external-programs/">è¿è¡Œå¤–éƒ¨ç¨‹åº</a></li><li><a class="tocitem" href="../calling-c-and-fortran-code/">è°ƒç”¨ C å’Œ Fortran ä»£ç </a></li><li><a class="tocitem" href="../handling-operating-system-variation/">å¤„ç†æ“ä½œç³»ç»Ÿå·®å¼‚</a></li><li><a class="tocitem" href="../environment-variables/">ç¯å¢ƒå˜é‡</a></li><li><a class="tocitem" href="../embedding/">åµŒå…¥ Julia</a></li><li><a class="tocitem" href="../code-loading/">ä»£ç åŠ è½½</a></li><li><a class="tocitem" href="../profile/">æ€§èƒ½åˆ†æ</a></li><li><a class="tocitem" href="../stacktraces/">æ ˆè·Ÿè¸ª</a></li><li><a class="tocitem" href="../performance-tips/">æ€§èƒ½å»ºè®®</a></li><li><a class="tocitem" href="../workflow-tips/">å·¥ä½œæµç¨‹å»ºè®®</a></li><li><a class="tocitem" href="../style-guide/">ä»£ç é£æ ¼æŒ‡å—</a></li><li><a class="tocitem" href="../faq/">å¸¸è§é—®é¢˜</a></li><li><a class="tocitem" href="../noteworthy-differences/">ä¸å…¶ä»–è¯­è¨€çš„æ˜¾è‘—å·®å¼‚</a></li><li><a class="tocitem" href="../unicode-input/">Unicode è¾“å…¥è¡¨</a></li><li><a class="tocitem" href="../command-line-options/">å‘½ä»¤è¡Œé€‰é¡¹</a></li></ul></li><li><span class="tocitem">Base</span><ul><li><a class="tocitem" href="../../base/base/">åŸºæœ¬åŠŸèƒ½</a></li><li><a class="tocitem" href="../../base/collections/">é›†åˆå’Œæ•°æ®ç»“æ„</a></li><li><a class="tocitem" href="../../base/math/">æ•°å­¦ç›¸å…³</a></li><li><a class="tocitem" href="../../base/numbers/">Numbers</a></li><li><a class="tocitem" href="../../base/strings/">å­—ç¬¦ä¸²</a></li><li><a class="tocitem" href="../../base/arrays/">æ•°ç»„</a></li><li><a class="tocitem" href="../../base/parallel/">Tasks</a></li><li><a class="tocitem" href="../../base/multi-threading/">Multi-Threading</a></li><li><a class="tocitem" href="../../base/constants/">å¸¸é‡</a></li><li><a class="tocitem" href="../../base/file/">æ–‡ä»¶ç³»ç»Ÿ</a></li><li><a class="tocitem" href="../../base/io-network/">I/O ä¸ç½‘ç»œ</a></li><li><a class="tocitem" href="../../base/punctuation/">è¿ç®—ç¬¦ä¸è®°å·</a></li><li><a class="tocitem" href="../../base/sort/">æ’åºåŠç›¸å…³å‡½æ•°</a></li><li><a class="tocitem" href="../../base/iterators/">è¿­ä»£ç›¸å…³</a></li><li><a class="tocitem" href="../../base/c/">C æ¥å£</a></li><li><a class="tocitem" href="../../base/libc/">C æ ‡å‡†åº“</a></li><li><a class="tocitem" href="../../base/stacktraces/">å †æ ˆè·Ÿè¸ª</a></li><li><a class="tocitem" href="../../base/simd-types/">SIMD æ”¯æŒ</a></li></ul></li><li><span class="tocitem">Standard Library</span><ul><li><a class="tocitem" href="../../stdlib/Artifacts/">Artifacts</a></li><li><a class="tocitem" href="../../stdlib/Base64/">Base64</a></li><li><a class="tocitem" href="../../stdlib/CRC32c/">CRC32c</a></li><li><a class="tocitem" href="../../stdlib/Dates/">æ—¥æœŸ</a></li><li><a class="tocitem" href="../../stdlib/DelimitedFiles/">åˆ†éš”ç¬¦æ–‡ä»¶</a></li><li><a class="tocitem" href="../../stdlib/Distributed/">Distributed Computing</a></li><li><a class="tocitem" href="../../stdlib/FileWatching/">æ–‡ä»¶ç›¸å…³äº‹ä»¶</a></li><li><a class="tocitem" href="../../stdlib/Future/">Future</a></li><li><a class="tocitem" href="../../stdlib/InteractiveUtils/">Interactive Utilities</a></li><li><a class="tocitem" href="../../stdlib/LazyArtifacts/">Lazy Artifacts</a></li><li><a class="tocitem" href="../../stdlib/LibGit2/">LibGit2</a></li><li><a class="tocitem" href="../../stdlib/Libdl/">åŠ¨æ€é“¾æ¥å™¨</a></li><li><a class="tocitem" href="../../stdlib/LinearAlgebra/">Linear Algebra</a></li><li><a class="tocitem" href="../../stdlib/Logging/">æ—¥å¿—è®°å½•</a></li><li><a class="tocitem" href="../../stdlib/Markdown/">Markdown</a></li><li><a class="tocitem" href="../../stdlib/Mmap/">å†…å­˜æ˜ å°„ I/O</a></li><li><a class="tocitem" href="../../stdlib/Printf/">Printf</a></li><li><a class="tocitem" href="../../stdlib/Profile/">æ€§èƒ½åˆ†æ</a></li><li><a class="tocitem" href="../../stdlib/REPL/">Julia REPL</a></li><li><a class="tocitem" href="../../stdlib/Random/">éšæœºæ•°</a></li><li><a class="tocitem" href="../../stdlib/SHA/">SHA</a></li><li><a class="tocitem" href="../../stdlib/Serialization/">åºåˆ—åŒ–</a></li><li><a class="tocitem" href="../../stdlib/SharedArrays/">å…±äº«æ•°ç»„</a></li><li><a class="tocitem" href="../../stdlib/Sockets/">å¥—æ¥å­—</a></li><li><a class="tocitem" href="../../stdlib/SparseArrays/">ç¨€ç–æ•°ç»„</a></li><li><a class="tocitem" href="../../stdlib/Statistics/">ç»Ÿè®¡</a></li><li><a class="tocitem" href="../../stdlib/TOML/">TOML</a></li><li><a class="tocitem" href="../../stdlib/Test/">å•å…ƒæµ‹è¯•</a></li><li><a class="tocitem" href="../../stdlib/UUIDs/">UUIDs</a></li><li><a class="tocitem" href="../../stdlib/Unicode/">Unicode</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../../devdocs/reflection/">åå°„ ä¸ è‡ªæˆ‘æ£€æŸ¥</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Documentation of Julia&#39;s Internals</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../devdocs/init/">Julia è¿è¡Œæ—¶çš„åˆå§‹åŒ–</a></li><li><a class="tocitem" href="../../devdocs/ast/">Julia çš„ AST</a></li><li><a class="tocitem" href="../../devdocs/types/">More about types</a></li><li><a class="tocitem" href="../../devdocs/object/">Memory layout of Julia Objects</a></li><li><a class="tocitem" href="../../devdocs/eval/">Julia ä»£ç çš„ eval</a></li><li><a class="tocitem" href="../../devdocs/callconv/">Calling Conventions</a></li><li><a class="tocitem" href="../../devdocs/compiler/">æœ¬æœºä»£ç ç”Ÿæˆè¿‡ç¨‹çš„é«˜çº§æ¦‚è¿°</a></li><li><a class="tocitem" href="../../devdocs/functions/">Julia å‡½æ•°</a></li><li><a class="tocitem" href="../../devdocs/cartesian/">ç¬›å¡å°”</a></li><li><a class="tocitem" href="../../devdocs/meta/">Talking to the compiler (the <code>:meta</code> mechanism)</a></li><li><a class="tocitem" href="../../devdocs/subarrays/">å­æ•°ç»„</a></li><li><a class="tocitem" href="../../devdocs/isbitsunionarrays/">isbits Union Optimizations</a></li><li><a class="tocitem" href="../../devdocs/sysimg/">System Image Building</a></li><li><a class="tocitem" href="../../devdocs/llvm/">Working with LLVM</a></li><li><a class="tocitem" href="../../devdocs/stdio/">printf() and stdio in the Julia runtime</a></li><li><a class="tocitem" href="../../devdocs/boundscheck/">è¾¹ç•Œæ£€æŸ¥</a></li><li><a class="tocitem" href="../../devdocs/locks/">Proper maintenance and care of multi-threading locks</a></li><li><a class="tocitem" href="../../devdocs/offset-arrays/">Arrays with custom indices</a></li><li><a class="tocitem" href="../../devdocs/require/">Module loading</a></li><li><a class="tocitem" href="../../devdocs/inference/">ç±»å‹æ¨å¯¼</a></li><li><a class="tocitem" href="../../devdocs/ssair/">Julia SSA-form IR</a></li><li><a class="tocitem" href="../../devdocs/gc-sa/">Static analyzer annotations for GC correctness in C code</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Developing/debugging Julia&#39;s C code</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../devdocs/backtraces/">æŠ¥å‘Šå’Œåˆ†æå´©æºƒï¼ˆæ®µé”™è¯¯ï¼‰</a></li><li><a class="tocitem" href="../../devdocs/debuggingtips/">gdb è°ƒè¯•æç¤º</a></li><li><a class="tocitem" href="../../devdocs/valgrind/">åœ¨Juliaä¸­ä½¿ç”¨Valgrind</a></li><li><a class="tocitem" href="../../devdocs/sanitizers/">Sanitizer support</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">æ‰‹å†Œ</a></li><li class="is-active"><a href>å¤šçº¿ç¨‹</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>å¤šçº¿ç¨‹</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://www.transifex.com/juliacn/manual-zh_cn/translate/#zh_CN/multi-threadingmd" title=" å®Œå–„ Transifex ä¸Šçš„ç¿»è¯‘"><span class="docs-icon fab">ï‚¬</span><span class="docs-label is-hidden-touch"> å®Œå–„ Transifex ä¸Šçš„ç¿»è¯‘</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="è®¾ç½®"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="man-multithreading"><a class="docs-heading-anchor" href="#man-multithreading">å¤šçº¿ç¨‹</a><a id="man-multithreading-1"></a><a class="docs-heading-anchor-permalink" href="#man-multithreading" title="Permalink"></a></h1><p>è®¿é—®æ­¤ <a href="https://julialang.org/blog/2019/07/multithreading/">åšå®¢æ–‡ç« </a> ä»¥äº†è§£ Julia å¤šçº¿ç¨‹ç‰¹æ€§ã€‚</p><h2 id="å¯ç”¨Juliaå¤šçº¿ç¨‹"><a class="docs-heading-anchor" href="#å¯ç”¨Juliaå¤šçº¿ç¨‹">å¯ç”¨Juliaå¤šçº¿ç¨‹</a><a id="å¯ç”¨Juliaå¤šçº¿ç¨‹-1"></a><a class="docs-heading-anchor-permalink" href="#å¯ç”¨Juliaå¤šçº¿ç¨‹" title="Permalink"></a></h2><p>Julia é»˜è®¤å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»£ç ï¼Œè¿™ç‚¹å¯ä»¥é€šè¿‡ <a href="../../base/multi-threading/#Base.Threads.nthreads"><code>Threads.nthreads()</code></a> æ¥ç¡®è®¤ï¼š</p><pre><code class="language-julia-repl">julia&gt; Threads.nthreads()
1</code></pre><p>æ‰§è¡Œçº¿ç¨‹çš„æ•°é‡é€šè¿‡ä½¿ç”¨<code>-t</code>/<code>--threads</code> å‘½ä»¤è¡Œå‚æ•°æˆ–ä½¿ç”¨<a href="../environment-variables/#JULIA_NUM_THREADS"><code>JULIA_NUM_THREADS</code></a> ç¯å¢ƒå˜é‡ã€‚ å½“ä¸¤è€…éƒ½è¢«æŒ‡å®šæ—¶ï¼Œ<code>-t</code>/<code>--threads</code> ä¼˜å…ˆçº§æ›´é«˜ã€‚</p><div class="admonition is-compat"><header class="admonition-header">Julia 1.5</header><div class="admonition-body"><p><code>-t</code>/<code>--threads</code> å‘½ä»¤è¡Œå‚æ•°è‡³å°‘éœ€è¦ Julia 1.5ã€‚åœ¨æ—§ç‰ˆæœ¬ä¸­ï¼Œä½ å¿…é¡»æ”¹ç”¨ç¯å¢ƒå˜é‡ã€‚</p></div></div><p>è®©æˆ‘ä»¬ä»¥4ä¸ªçº¿ç¨‹å¯åŠ¨Julia</p><pre><code class="language-bash">$ julia --threads 4</code></pre><p>ç°åœ¨ç¡®è®¤ä¸‹ç¡®å®æœ‰4ä¸ªçº¿ç¨‹ï¼š</p><pre><code class="language-julia-repl">julia&gt; Threads.nthreads()
4</code></pre><p>ä¸è¿‡æˆ‘ä»¬ç°åœ¨æ˜¯åœ¨ master çº¿ç¨‹ï¼Œç”¨ <a href="../../base/multi-threading/#Base.Threads.threadid"><code>Threads.threadid</code></a> ç¡®è®¤ä¸‹ï¼š</p><pre><code class="language-julia-repl">julia&gt; Threads.threadid()
1</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>å¦‚æœä½ æ›´å–œæ¬¢ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼è®¾ç½®å®ƒ Bash (Linux/macOS):</p><pre><code class="language-bash">export JULIA_NUM_THREADS=4</code></pre><p>C shell on Linux/macOS, CMD on Windows:</p><pre><code class="language-bash">set JULIA_NUM_THREADS=4</code></pre><p>Powershell on Windows:</p><pre><code class="language-powershell">$env:JULIA_NUM_THREADS=4</code></pre><p>Note that this must be done <em>before</em> starting Julia.</p></div></div><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>ä½¿ç”¨ <code>-t</code>/<code>--threads</code> æŒ‡å®šçš„çº¿ç¨‹æ•°ä¼ æ’­åˆ°ä½¿ç”¨ <code>-p</code>/<code>--procs</code> æˆ– <code>--machine-file</code> å‘½ä»¤è¡Œé€‰é¡¹äº§ç”Ÿçš„å·¥ä½œè¿›ç¨‹ã€‚ ä¾‹å¦‚ï¼Œ<code>julia -p2 -t2</code> äº§ç”Ÿ 1 ä¸ªä¸»è¿›ç¨‹å’Œ 2 ä¸ªå·¥ä½œè¿›ç¨‹ï¼Œå¹¶ä¸”æ‰€æœ‰ä¸‰ä¸ªè¿›ç¨‹éƒ½å¯ç”¨äº† 2 ä¸ªçº¿ç¨‹ã€‚ è¦å¯¹å·¥ä½œçº¿ç¨‹è¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œè¯·ä½¿ç”¨ <a href="../../stdlib/Distributed/#Distributed.addprocs"><code>addprocs</code></a> å¹¶å°† <code>-t</code>/<code>--threads</code> ä½œä¸º <code>exeflags</code> ä¼ é€’ã€‚</p></div></div><h2 id="Data-race-freedom"><a class="docs-heading-anchor" href="#Data-race-freedom">Data-race freedom</a><a id="Data-race-freedom-1"></a><a class="docs-heading-anchor-permalink" href="#Data-race-freedom" title="Permalink"></a></h2><p>You are entirely responsible for ensuring that your program is data-race free, and nothing promised here can be assumed if you do not observe that requirement. The observed results may be highly unintuitive.</p><p>The best way to ensure this is to acquire a lock around any access to data that can be observed from multiple threads. For example, in most cases you should use the following code pattern:</p><pre><code class="language-julia-repl">julia&gt; lock(lk) do
           use(a)
       end

julia&gt; begin
           lock(lk)
           try
               use(a)
           finally
               unlock(lk)
           end
       end</code></pre><p>å…¶ä¸­ <code>lk</code> æ˜¯ä¸€ä¸ªé”ï¼ˆä¾‹å¦‚ <code>ReentrantLock()</code>ï¼‰ï¼Œ <code>a</code> æ˜¯æ•°æ®ã€‚</p><p>Additionally, Julia is not memory safe in the presence of a data race. Be very careful about reading <em>any</em> data if another thread might write to it! Instead, always use the lock pattern above when changing data (such as assigning to a global or closure variable) accessed by other threads.</p><pre><code class="language-julia">Thread 1:
global b = false
global a = rand()
global b = true

Thread 2:
while !b; end
bad_read1(a) # it is NOT safe to access `a` here!

Thread 3:
while !@isdefined(a); end
bad_read2(a) # it is NOT safe to access `a` here</code></pre><h2 id="@threadså®"><a class="docs-heading-anchor" href="#@threadså®"><code>@threads</code>å®</a><a id="@threadså®-1"></a><a class="docs-heading-anchor-permalink" href="#@threadså®" title="Permalink"></a></h2><p>ä¸‹é¢ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æµ‹è¯•æˆ‘ä»¬åŸç”Ÿçš„çº¿ç¨‹ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªå…¨é›¶çš„æ•°ç»„ï¼š</p><pre><code class="language-julia-repl">julia&gt; a = zeros(10)
10-element Vector{Float64}:
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0</code></pre><p>ç°åœ¨ç”¨4ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿæ“ä½œè¿™ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªçº¿ç¨‹å¾€å¯¹åº”çš„ä½ç½®å†™å…¥çº¿ç¨‹IDã€‚</p><p>Julia ç”¨ <a href="../../base/multi-threading/#Base.Threads.@threads"><code>Threads.@threads</code></a> å®å®ç°å¹¶è¡Œå¾ªç¯ï¼Œè¯¥å®åŠ åœ¨ <code>for</code> å¾ªç¯å‰é¢ï¼Œæç¤º Julia å¾ªç¯éƒ¨åˆ†æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹çš„åŒºåŸŸï¼š</p><pre><code class="language-julia-repl">julia&gt; Threads.@threads for i = 1:10
           a[i] = Threads.threadid()
       end</code></pre><p>The iteration space is split among the threads, after which each thread writes its thread ID to its assigned locations:</p><pre><code class="language-julia-repl">julia&gt; a
10-element Vector{Float64}:
 1.0
 1.0
 1.0
 2.0
 2.0
 2.0
 3.0
 3.0
 4.0
 4.0</code></pre><p>æ³¨æ„ <a href="../../base/multi-threading/#Base.Threads.@threads"><code>Threads.@threads</code></a> å¹¶æ²¡æœ‰ä¸€ä¸ªåƒ <a href="../../stdlib/Distributed/#Distributed.@distributed"><code>@distributed</code></a> ä¸€æ ·çš„å¯é€‰çš„ reduction å‚æ•°ã€‚</p><h2 id="åŸå­æ“ä½œ"><a class="docs-heading-anchor" href="#åŸå­æ“ä½œ">åŸå­æ“ä½œ</a><a id="åŸå­æ“ä½œ-1"></a><a class="docs-heading-anchor-permalink" href="#åŸå­æ“ä½œ" title="Permalink"></a></h2><p>Julia æ”¯æŒè®¿é—®å’Œä¿®æ”¹å€¼çš„<strong>åŸå­</strong>æ“ä½œï¼Œå³ä»¥ä¸€ç§çº¿ç¨‹å®‰å…¨çš„æ–¹å¼æ¥é¿å…<a href="https://en.wikipedia.org/wiki/Race_condition">ç«æ€æ¡ä»¶</a>ã€‚ä¸€ä¸ªå€¼ï¼ˆå¿…é¡»æ˜¯åŸºæœ¬ç±»å‹çš„ï¼Œprimitive typeï¼‰å¯ä»¥é€šè¿‡ <a href="../../base/multi-threading/#Base.Threads.Atomic"><code>Threads.Atomic</code></a> æ¥åŒ…è£…èµ·æ¥ä»è€Œæ”¯æŒåŸå­æ“ä½œã€‚ä¸‹é¢çœ‹ä¸ªä¾‹å­ï¼š</p><pre><code class="language-julia-repl">julia&gt; i = Threads.Atomic{Int}(0);

julia&gt; ids = zeros(4);

julia&gt; old_is = zeros(4);

julia&gt; Threads.@threads for id in 1:4
           old_is[id] = Threads.atomic_add!(i, id)
           ids[id] = id
       end

julia&gt; old_is
4-element Vector{Float64}:
 0.0
 1.0
 7.0
 3.0

julia&gt; i[]
 10

julia&gt; ids
4-element Vector{Float64}:
 1.0
 2.0
 3.0
 4.0</code></pre><p>å¦‚æœä¸åŠ  <code>Atomic</code> çš„è¯ï¼Œé‚£ä¹ˆä¼šå› ä¸ºç«æ€æ¡ä»¶è€Œå¾—åˆ°é”™è¯¯çš„ç»“æœï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ²¡æœ‰é¿å…ç«æ€æ¡ä»¶çš„ä¾‹å­ï¼š</p><pre><code class="language-julia-repl">julia&gt; using Base.Threads

julia&gt; nthreads()
4

julia&gt; acc = Ref(0)
Base.RefValue{Int64}(0)

julia&gt; @threads for i in 1:1000
          acc[] += 1
       end

julia&gt; acc[]
926

julia&gt; acc = Atomic{Int64}(0)
Atomic{Int64}(0)

julia&gt; @threads for i in 1:1000
          atomic_add!(acc, 1)
       end

julia&gt; acc[]
1000</code></pre><h2 id="man-atomics"><a class="docs-heading-anchor" href="#man-atomics">Per-field atomics</a><a id="man-atomics-1"></a><a class="docs-heading-anchor-permalink" href="#man-atomics" title="Permalink"></a></h2><p>We can also use atomics on a more granular level using the <a href="manual/@ref Base.@atomic"><code>@atomic</code></a>, <a href="manual/@ref Base.@atomicswap"><code>@atomicswap</code></a>, and <a href="manual/@ref Base.@atomicreplace"><code>@atomicreplace</code></a> macros.</p><p>Specific details of the memory model and other details of the design are written in the <a href="https://gist.github.com/vtjnash/11b0031f2e2a66c9c24d33e810b34ec0">Julia Atomics Manifesto</a>, which will later be published formally.</p><p>Any field in a struct declaration can be decorated with <code>@atomic</code>, and then any write must be marked with <code>@atomic</code> also, and must use one of the defined atomic orderings (:monotonic, :acquire, :release, :acquire_release, or :sequentially_consistent). Any read of an atomic field can also be annotated with an atomic ordering constraint, or will be done with monotonic (relaxed) ordering if unspecified.</p><h2 id="å‰¯ä½œç”¨å’Œå¯å˜çš„å‡½æ•°å‚æ•°"><a class="docs-heading-anchor" href="#å‰¯ä½œç”¨å’Œå¯å˜çš„å‡½æ•°å‚æ•°">å‰¯ä½œç”¨å’Œå¯å˜çš„å‡½æ•°å‚æ•°</a><a id="å‰¯ä½œç”¨å’Œå¯å˜çš„å‡½æ•°å‚æ•°-1"></a><a class="docs-heading-anchor-permalink" href="#å‰¯ä½œç”¨å’Œå¯å˜çš„å‡½æ•°å‚æ•°" title="Permalink"></a></h2><p>When using multi-threading we have to be careful when using functions that are not <a href="https://en.wikipedia.org/wiki/Pure_function">pure</a> as we might get a wrong answer. For instance functions that have a <a href="../style-guide/#bang-convention">name ending with <code>!</code></a> by convention modify their arguments and thus are not pure.</p><h2 id="@threadcall"><a class="docs-heading-anchor" href="#@threadcall">@threadcall</a><a id="@threadcall-1"></a><a class="docs-heading-anchor-permalink" href="#@threadcall" title="Permalink"></a></h2><p>External libraries, such as those called via <a href="../../base/c/#ccall"><code>ccall</code></a>, pose a problem for Julia&#39;s task-based I/O mechanism. If a C library performs a blocking operation, that prevents the Julia scheduler from executing any other tasks until the call returns. (Exceptions are calls into custom C code that call back into Julia, which may then yield, or C code that calls <code>jl_yield()</code>, the C equivalent of <a href="../../base/parallel/#Base.yield"><code>yield</code></a>.)</p><p>The <a href="../../base/multi-threading/#Base.@threadcall"><code>@threadcall</code></a> macro provides a way to avoid stalling execution in such a scenario. It schedules a C function for execution in a separate thread. A threadpool with a default size of 4 is used for this. The size of the threadpool is controlled via environment variable <code>UV_THREADPOOL_SIZE</code>. While waiting for a free thread, and during function execution once a thread is available, the requesting task (on the main Julia event loop) yields to other tasks. Note that <code>@threadcall</code> does not return until the execution is complete. From a user point of view, it is therefore a blocking call like other Julia APIs.</p><p>éå¸¸å…³é”®çš„ä¸€ç‚¹æ˜¯ï¼Œè¢«è°ƒç”¨çš„å‡½æ•°ä¸ä¼šå†è°ƒç”¨å› Juliaã€‚</p><p><code>@threadcall</code> åœ¨ Julia æœªæ¥çš„ç‰ˆæœ¬ä¸­å¯èƒ½ä¼šè¢«ç§»é™¤æˆ–æ”¹å˜ã€‚</p><h2 id="Caveats"><a class="docs-heading-anchor" href="#Caveats">Caveats</a><a id="Caveats-1"></a><a class="docs-heading-anchor-permalink" href="#Caveats" title="Permalink"></a></h2><p>At this time, most operations in the Julia runtime and standard libraries can be used in a thread-safe manner, if the user code is data-race free. However, in some areas work on stabilizing thread support is ongoing. Multi-threaded programming has many inherent difficulties, and if a program using threads exhibits unusual or undesirable behavior (e.g. crashes or mysterious results), thread interactions should typically be suspected first.</p><p>There are a few specific limitations and warnings to be aware of when using threads in Julia:</p><ul><li>Base collection types require manual locking if used simultaneously by multiple threads where at least one thread modifies the collection (common examples include <code>push!</code> on arrays, or inserting items into a <code>Dict</code>).</li><li>After a task starts running on a certain thread (e.g. via <code>@spawn</code>), it will always be restarted on the same thread after blocking. In the future this limitation will be removed, and tasks will migrate between threads.</li><li><code>@threads</code> currently uses a static schedule, using all threads and assigning equal iteration counts to each. In the future the default schedule is likely to change to be dynamic.</li><li>The schedule used by <code>@spawn</code> is nondeterministic and should not be relied on.</li><li>Compute-bound, non-memory-allocating tasks can prevent garbage collection from running in other threads that are allocating memory. In these cases it may be necessary to insert a manual call to <code>GC.safepoint()</code> to allow GC to run. This limitation will be removed in the future.</li><li>Avoid running top-level operations, e.g. <code>include</code>, or <code>eval</code> of type, method, and module definitions in parallel.</li><li>Be aware that finalizers registered by a library may break if threads are enabled. This may require some transitional work across the ecosystem before threading can be widely adopted with confidence. See the next section for further details.</li></ul><h2 id="Safe-use-of-Finalizers"><a class="docs-heading-anchor" href="#Safe-use-of-Finalizers">Safe use of Finalizers</a><a id="Safe-use-of-Finalizers-1"></a><a class="docs-heading-anchor-permalink" href="#Safe-use-of-Finalizers" title="Permalink"></a></h2><p>Because finalizers can interrupt any code, they must be very careful in how they interact with any global state. Unfortunately, the main reason that finalizers are used is to update global state (a pure function is generally rather pointless as a finalizer). This leads us to a bit of a conundrum. There are a few approaches to dealing with this problem:</p><ol><li><p>When single-threaded, code could call the internal <code>jl_gc_enable_finalizers</code> C function to prevent finalizers from being scheduled inside a critical region. Internally, this is used inside some functions (such as our C locks) to prevent recursion when doing certain operations (incremental package loading, codegen, etc.). The combination of a lock and this flag can be used to make finalizers safe.</p></li><li><p>A second strategy, employed by Base in a couple places, is to explicitly delay a finalizer until it may be able to acquire its lock non-recursively. The following example demonstrates how this strategy could be applied to <code>Distributed.finalize_ref</code>:</p><pre><code class="language-julia">function finalize_ref(r::AbstractRemoteRef)
    if r.where &gt; 0 # Check if the finalizer is already run
        if islocked(client_refs) || !trylock(client_refs)
            # delay finalizer for later if we aren&#39;t free to acquire the lock
            finalizer(finalize_ref, r)
            return nothing
        end
        try # `lock` should always be followed by `try`
            if r.where &gt; 0 # Must check again here
                # Do actual cleanup here
                r.where = 0
            end
        finally
            unlock(client_refs)
        end
    end
    nothing
end</code></pre></li><li><p>A related third strategy is to use a yield-free queue. We don&#39;t currently have a lock-free queue implemented in Base, but <code>Base.InvasiveLinkedListSynchronized{T}</code> is suitable. This can frequently be a good strategy to use for code with event loops. For example, this strategy is employed by <code>Gtk.jl</code> to manage lifetime ref-counting. In this approach, we don&#39;t do any explicit work inside the <code>finalizer</code>, and instead add it to a queue to run at a safer time. In fact, Julia&#39;s task scheduler already uses this, so defining the finalizer as <code>x -&gt; @spawn do_cleanup(x)</code> is one example of this approach. Note however that this doesn&#39;t control which thread <code>do_cleanup</code> runs on, so <code>do_cleanup</code> would still need to acquire a lock. That doesn&#39;t need to be true if you implement your own queue, as you can explicitly only drain that queue from your thread.</p></li></ol></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../asynchronous-programming/">Â« Asynchronous Programming</a><a class="docs-footer-nextpage" href="../distributed-computing/">Multi-processing and Distributed Computing Â»</a><div class="flexbox-break"></div><p class="footer-message">ğŸ“¢ğŸ“¢ğŸ“¢Juliaä¸­æ–‡ç¤¾åŒºç°å·²åŠ å…¥â€œå¼€æºè½¯ä»¶ä¾›åº”é“¾ç‚¹äº®è®¡åˆ’â€ï¼Œå¦‚æœä½ æƒ³æ”¹å–„Juliaä¸­æ–‡æ–‡æ¡£çš„ç¿»è¯‘ï¼Œé‚£å°±èµ¶å¿«æ¥ <a href="https://summer.iscas.ac.cn/#/org/prodetail/210370191">æŠ¥å</a> å§ï¼</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">è®¾ç½®</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">é€‰æ‹©ä¸»é¢˜</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>æœ¬æ–‡æ¡£åœ¨<span class="colophon-date" title="2021 å…«æœˆ 13 å‘¨äº” 15:24">2021 å…«æœˆ 13 å‘¨äº”</span>ç”±<a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a>ä½¿ç”¨1.6.2ç‰ˆæœ¬çš„Juliaç”Ÿæˆã€‚</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
